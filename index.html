<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‚òÄÔ∏è –ë–õ–ò–ù–ù–´–ô –®–£–¢–ï–† ¬∑ –ú–∞—Å–ª–µ–Ω–∏—Ü–∞</title>
    <style>
        /* ===== –ê–î–ê–ü–¢–ò–í–ù–´–ô –ú–û–ë–ò–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            height: 100vh;
            height: 100dvh; /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            width: 100vw;
            overflow: hidden;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: #fad0a5;
            position: fixed; /* –§–∏–∫—Å–∞—Ü–∏—è –æ—Ç —Å–∫—Ä–æ–ª–ª–∞ */
        }

        .game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 500px; /* –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤ */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: linear-gradient(rgba(255, 222, 191, 0.9), rgba(255, 228, 204, 0.9)), 
                        url('—Ñ–æ–Ω_2.jpeg') center/cover no-repeat;
            padding-top: env(safe-area-inset-top, 10px);
            padding-bottom: env(safe-area-inset-bottom, 10px);
            border-left: 2px solid #d2691e;
            border-right: 2px solid #d2691e;
        }

        /* –®–∞–ø–∫–∞ —Å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .header {
            flex: 0 0 auto;
            height: 70px;
            background: linear-gradient(165deg, #ffecd2, #fcdec2);
            border: 4px solid #c28a3b;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 20;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label { font-size: 10px; color: #7b3f00; font-weight: 800; }
        .stat-value { font-size: 20px; font-weight: 900; color: #a0522d; }

        .lives-row { display: flex; gap: 4px; }
        .life-dot {
            width: 14px;
            height: 14px;
            background: radial-gradient(circle at 30% 30%, #ffc068, #d41a1a);
            border-radius: 50%;
            box-shadow: 0 2px 0 #9c5a2c;
        }
        .life-dot.lost { background: #bbb; box-shadow: none; opacity: 0.5; transform: scale(0.8); }

        .canvas-container {
            flex: 1;
            position: relative;
            width: 100%;
            margin-top: 5px;
            background: rgba(255, 235, 190, 0.2);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –ø–∞–ª—å—Ü—ã */
        .pause-button, .sound-toggle {
            position: absolute;
            bottom: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            z-index: 50;
            border: 3px solid #ffe28c;
            box-shadow: 0 5px 0 #9c5a2b;
        }
        .pause-button { left: 15px; background: #f57c00; }
        .sound-toggle { right: 15px; background: #e68a2e; }
        .pause-button:active, .sound-toggle:active { transform: translateY(4px); box-shadow: 0 1px 0 #9c5a2b; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal, .modal-pause {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(70, 40, 15, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #fff7e6;
            width: 90%;
            padding: 25px 15px;
            border-radius: 30px;
            text-align: center;
            border: 6px solid #ffb347;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .flavors-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .flavor-item {
            background: rgba(255, 235, 200, 0.8);
            padding: 8px 4px;
            border-radius: 15px;
            border: 2px solid #d2691e;
        }

        .flavor-preview { width: 30px; height: 30px; margin: 0 auto 5px; background-size: cover; }
        .flavor-name { font-size: 9px; font-weight: 800; color: #6b3f00; }

        button {
            background: #f57c00;
            border: none; color: white;
            padding: 15px 30px; font-size: 20px;
            border-radius: 40px; font-weight: 900;
            box-shadow: 0 8px 0 #b85a1a;
            margin-top: 10px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <div class="header">
            <div class="stat-item">
                <span class="stat-label">ü•û –°–ß–ï–¢</span>
                <span class="stat-value" id="score">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">üçØ –ñ–ò–ó–ù–ò</span>
                <div class="lives-row" id="lives-container"></div>
            </div>
            <div class="stat-item">
                <span class="stat-label">üèÜ –†–ï–ö–û–†–î</span>
                <span class="stat-value" id="high-score">0</span>
            </div>
        </div>

        <div class="canvas-container" id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            
            <div id="pauseBtn" class="pause-button">‚è∏</div>
            <div id="soundToggle" class="sound-toggle">‚ô¨</div>

            <div id="modal" class="modal">
                <div class="modal-content">
                    <h1 style="color: #b6491a; font-size: 24px;">‚òÄÔ∏è –ú–ê–°–õ–ï–ù–ò–¶–ê</h1>
                    <p style="margin: 10px 0; font-size: 14px;">–°—Ç—Ä–µ–ª—è–π –±–ª–∏–Ω–∞–º–∏, —Å–æ–±–∏—Ä–∞–π –ø–æ 3 –≤ —Ä—è–¥!</p>
                    
                    <div id="flavors-section">
                        <div class="flavors-grid">
                            <div class="flavor-item"><div class="flavor-preview" style="background-image: url('honey.png')"></div><span class="flavor-name">–ú–Å–î</span></div>
                            <div class="flavor-item"><div class="flavor-preview" style="background-image: url('Strawberry.png')"></div><span class="flavor-name">–Ø–ì–û–î–´</span></div>
                            <div class="flavor-item"><div class="flavor-preview" style="background-image: url('milk.png')"></div><span class="flavor-name">–°–ì–£–©–Å–ù–ö–ê</span></div>
                            <div class="flavor-item"><div class="flavor-preview" style="background-image: url('cheese.png')"></div><span class="flavor-name">–°–´–†</span></div>
                            <div class="flavor-item"><div class="flavor-preview" style="background-image: url('meat.png')"></div><span class="flavor-name">–ú–Ø–°–û</span></div>
                            <div class="flavor-item"><div style="font-size: 20px;">üí£</div><span class="flavor-name">–ë–û–ú–ë–ê</span></div>
                        </div>
                    </div>
                    
                    <button id="action-btn">–ò–ì–†–ê–¢–¨</button>
                </div>
            </div>

            <div id="pauseModal" class="modal-pause hidden">
                <div class="modal-content">
                    <h2>–ü–ê–£–ó–ê</h2>
                    <button id="resumeBtn">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const canvas = document.getElementById('gameCanvas');
            const container = document.getElementById('canvas-container');
            const ctx = canvas.getContext('2d');

            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            let RADIUS, DIAMETER, SPEED, offsetX, cols, rows;
            const MAX_LIVES = 5;

            const PANCAKE_IMAGES = ['honey.png', 'Strawberry.png', 'milk.png', 'cheese.png', 'meat.png'];
            let pancakeImgs = [];
            let bombImg = new Image();
            bombImg.src = 'bomb.png';

            PANCAKE_IMAGES.forEach(src => {
                let img = new Image();
                img.src = src;
                pancakeImgs.push(img);
            });

            const PANCAKE_TYPES = [
                { bgColor: '#ffecc2', border: '#fa9a00' },
                { bgColor: '#ffebed', border: '#e91e63' },
                { bgColor: '#f0f4f8', border: '#2196f3' },
                { bgColor: '#fff9c4', border: '#fbc02d' },
                { bgColor: '#efebe9', border: '#795548' }
            ];
            
            const BOMB_TYPE = 99;
            let grid = [], particles = [], falling = [];
            let score = 0, lives = MAX_LIVES, state = 'MENU';
            let shooter = { x: 0, y: 0, curr: 0, next: 0, ball: null };
            let isAiming = false, aimAngle = -Math.PI / 2;
            let soundEnabled = true;

            function resize() {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                
                // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞: 8 –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ –ª—é–±–æ–π —ç–∫—Ä–∞–Ω
                cols = 8; 
                DIAMETER = canvas.width / cols;
                RADIUS = DIAMETER / 2;
                offsetX = 0;
                rows = Math.floor(canvas.height / DIAMETER);
                
                shooter.x = canvas.width / 2;
                shooter.y = canvas.height - (DIAMETER * 1.2);
                SPEED = canvas.height * 0.04; // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
            }

            function initGame() {
                resize();
                score = 0; lives = MAX_LIVES;
                state = 'PLAYING';
                grid = [];
                for (let r = 0; r < rows; r++) grid[r] = new Array(cols).fill(null);
                for (let r = 0; r < 5; r++) createRow(r);
                shooter.curr = randType();
                shooter.next = randType();
                updateUI();
                modal.classList.add('hidden');
            }

            function createRow(r) {
                for (let c = 0; c < cols; c++) {
                    if (Math.random() > 0.2) {
                        grid[r][c] = {
                            type: Math.random() < 0.05 ? BOMB_TYPE : randType(),
                            x: c * DIAMETER + RADIUS,
                            y: r * DIAMETER + RADIUS
                        };
                    }
                }
            }

            function randType() { return Math.floor(Math.random() * PANCAKE_IMAGES.length); }

            // –õ–æ–≥–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            function drawBall(x, y, type, r = RADIUS) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(x, y, r - 2, 0, Math.PI * 2);
                
                if (type === BOMB_TYPE) {
                    ctx.fillStyle = '#333';
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    ctx.fillText('üí£', x, y + 5);
                } else {
                    ctx.clip();
                    // –§–æ–Ω
                    ctx.fillStyle = PANCAKE_TYPES[type].bgColor;
                    ctx.fill();
                    // –ö–∞—Ä—Ç–∏–Ω–∫–∞
                    if (pancakeImgs[type].complete) {
                        ctx.drawImage(pancakeImgs[type], x - r, y - r, r * 2, r * 2);
                    }
                    // –û–±–≤–æ–¥–∫–∞
                    ctx.strokeStyle = PANCAKE_TYPES[type].border;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                ctx.restore();
            }

            function update() {
                if (state !== 'PLAYING') return;

                if (shooter.ball) {
                    let b = shooter.ball;
                    b.x += b.vx;
                    b.y += b.vy;

                    // –û—Ç—Å–∫–æ–∫–∏ –æ—Ç —Å—Ç–µ–Ω
                    if (b.x < RADIUS || b.x > canvas.width - RADIUS) b.vx *= -1;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
                    if (b.y < RADIUS) { snap(b); }
                    else {
                        for (let r = 0; r < rows; r++) {
                            for (let c = 0; c < cols; c++) {
                                let cell = grid[r][c];
                                if (cell && Math.hypot(b.x - cell.x, b.y - cell.y) < DIAMETER * 0.8) {
                                    snap(b); return;
                                }
                            }
                        }
                    }
                    if (b.y < -RADIUS) resetShot();
                }
            }

            function snap(b) {
                let c = Math.round((b.x - RADIUS) / DIAMETER);
                let r = Math.round((b.y - RADIUS) / DIAMETER);
                c = Math.max(0, Math.min(c, cols - 1));
                r = Math.max(0, Math.min(r, rows - 1));

                if (grid[r][c]) r++; // –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ, —Å–ø—É—Å–∫–∞–µ–º—Å—è –Ω–∏–∂–µ
                
                if (r < rows) {
                    grid[r][c] = { type: b.type, x: c * DIAMETER + RADIUS, y: r * DIAMETER + RADIUS };
                    if (!checkMatches(r, c, b.type)) {
                        lives--;
                        if (lives <= 0) { addNewRow(); lives = MAX_LIVES; }
                    }
                }
                resetShot();
            }

            function checkMatches(r, c, type) {
                let matched = getMatches(r, c, type, []);
                if (matched.length >= 3) {
                    matched.forEach(m => grid[m.r][m.c] = null);
                    score += matched.length * 10;
                    updateUI();
                    return true;
                }
                return false;
            }

            function getMatches(r, c, type, found) {
                let key = `${r},${c}`;
                if (r < 0 || r >= rows || c < 0 || c >= cols || !grid[r][c] || grid[r][c].type !== type || found.includes(key)) return [];
                found.push(key);
                let res = [{r, c}];
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(d => {
                    res = res.concat(getMatches(r+d[0], c+d[1], type, found));
                });
                return res;
            }

            function addNewRow() {
                for (let r = rows - 1; r > 0; r--) grid[r] = [...grid[r-1]];
                grid[0] = new Array(cols).fill(null);
                createRow(0);
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞
                if (grid[rows-2].some(cell => cell !== null)) endGame();
            }

            function resetShot() {
                shooter.ball = null;
                shooter.curr = shooter.next;
                shooter.next = randType();
                updateUI();
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // –°–µ—Ç–∫–∞ (—Ñ–æ–Ω)
                ctx.strokeStyle = 'rgba(0,0,0,0.05)';
                for(let i=0; i<cols; i++) ctx.strokeRect(i*DIAMETER, 0, DIAMETER, canvas.height);

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –±–ª–∏–Ω–æ–≤
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        if (grid[r][c]) drawBall(grid[r][c].x, grid[r][c].y, grid[r][c].type);
                    }
                }

                // –ü—Ä–∏—Ü–µ–ª
                if (isAiming && !shooter.ball) {
                    ctx.beginPath();
                    ctx.setLineDash([5, 10]);
                    ctx.moveTo(shooter.x, shooter.y);
                    ctx.lineTo(shooter.x + Math.cos(aimAngle) * 100, shooter.y + Math.sin(aimAngle) * 100);
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // –ü—É—à–∫–∞
                drawBall(shooter.x, shooter.y, shooter.curr);
                
                // –°–Ω–∞—Ä—è–¥ –≤ –ø–æ–ª–µ—Ç–µ
                if (shooter.ball) drawBall(shooter.ball.x, shooter.ball.y, shooter.ball.type);
            }

            function updateUI() {
                document.getElementById('score').innerText = score;
                const container = document.getElementById('lives-container');
                container.innerHTML = '';
                for(let i=0; i<MAX_LIVES; i++) {
                    let dot = document.createElement('div');
                    dot.className = 'life-dot' + (i >= lives ? ' lost' : '');
                    container.appendChild(dot);
                }
            }

            function endGame() {
                state = 'END';
                alert("–ú–∞—Å–ª–µ–Ω–∏—Ü–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å! –°—á–µ—Ç: " + score);
                location.reload();
            }

            // –°–æ–±—ã—Ç–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            canvas.addEventListener('pointerdown', e => {
                if (state !== 'PLAYING') return;
                isAiming = true;
                handleMove(e);
            });

            canvas.addEventListener('pointermove', e => { if (isAiming) handleMove(e); });
            canvas.addEventListener('pointerup', () => {
                if (isAiming && !shooter.ball) {
                    shooter.ball = {
                        x: shooter.x, y: shooter.y,
                        vx: Math.cos(aimAngle) * SPEED,
                        vy: Math.sin(aimAngle) * SPEED,
                        type: shooter.curr
                    };
                }
                isAiming = false;
            });

            function handleMove(e) {
                const rect = canvas.getBoundingClientRect();
                const tx = e.clientX - rect.left;
                const ty = e.clientY - rect.top;
                aimAngle = Math.atan2(ty - shooter.y, tx - shooter.x);
            }

            document.getElementById('action-btn').onclick = initGame;
            document.getElementById('pauseBtn').onclick = () => {
                state = state === 'PLAYING' ? 'PAUSED' : 'PLAYING';
                document.getElementById('pauseModal').classList.toggle('hidden');
            };
            document.getElementById('resumeBtn').onclick = () => {
                state = 'PLAYING';
                document.getElementById('pauseModal').classList.add('hidden');
            };

            function loop() {
                update();
                draw();
                requestAnimationFrame(loop);
            }

            window.onresize = resize;
            resize();
            loop();
        })();
    </script>
</body>
</html>
